---
title: "initial_exploration"
author: "Jason Hammett"
date: "November 22, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Install function courtesy of CSCI 349
my.install <- function(pkg){
  if (!(pkg %in% installed.packages()[,1])){
    install.packages(pkg)
  }
  return (require(pkg, character.only=TRUE))
}

#Decision Tree Libs
my.install("rpart")
my.install("rpart.plot")
#Plotting Libs
my.install("ggplot2")
my.install("ggmap")
my.install("leaflet")

#colorblind settings
# The palette with grey:
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# To use for fills, add
#scale_fill_manual(values=cbPalette)

# To use for line and point colors, add
#scale_colour_manual(values=cbPalette)
```

## Baltimore Crime
### Initial Exploration

Let's begin by loading the three data files in. Note that this data is from fall 2017. 
We have data on: calls, arrests, and victims. Calls is a very large file, and arrests has pretty messy data, so we'll do a separate rmd of EDA on those.
```{r importing data}
victims <- read.csv("Data/BPD_Part_1_Victim_Based_Crime_Data.csv")
```

Let's look at the structure of the file.

```{r structure}
str(victims)
```

Now a summary.

```{r summary}
summary(victims)
```

We've learned that this is a victim based crime dataset.
Firstly, here are the factors that make up the victims dataset.
* Crime Date - MM/DD/YYYY
* CrimeTime - HH:mm:ss
* CrimeCode
* Location
* Description
* Inside.Outside - can be transformed to a logical
* Weapon
* Post
* District
* Neighborhood
* Longitude
* Latitude
* Location.1 - A character verion of the latitude longitude pair
* Premise

Now time to clean the data.
First, I will uniformly make Inside.Outside either "Inside" or "Outsside"

```{r inside-outside}
insideOutsideVector <- victims$Inside.Outside
#Convert single letter to full name
insideOutsideVector[which(insideOutsideVector == "O")] <- "Outside"
insideOutsideVector[which(insideOutsideVector == "I")] <- "Inside"
#Change blank's to NAs
insideOutsideVector[which(insideOutsideVector == "")] <- NA
#Remove unnecessary levels
insideOutsideVector <- factor(insideOutsideVector)
#Add it back into the data.frame
victims$Inside.Outside <- insideOutsideVector
```

Looking at the levels of the Premise attribute shows inconsistency with the data.
```{r premise}
levels(victims$Premise)
```

The inconsistency is beyond simply capitalization. Phrases are cut off. There are not a uniform descriptors for similar types of premise.
For instance, there is "BAR" as well as "TAVERN/NIG". I am going to presume this is "NIGHTCLUB" cut off.
There's "Church" and "RELIGOUS", so I'll need to manually edit these.

```{r premises}
premises <- victims$Premise
#First, change blanks to NAs
premises[which(premises == "")] <- NA
#Now, I'll capitalize every element and reform the levels
premises <- toupper(premises)

#Recalculate the levels
premises <- factor(premises)
#Place it back in dataframe
victims$Premise <- premises
#Clean up
rm(premises)
```

To facilitate more data, I'll create a new variable with cleaner premises and specify the old one PremiseDetailed. I'll also create a column called PremiseCategory that is RESIDENTIAL, BUSINESS, GOVERNMENT, INDUSTRIAL, PARK, TRANSPORT, PUBLICSERVICE
```{r premises detail}
victims$PremiseDetailed <- victims$Premise
victims$PremiseCategory <- victims$Premise

#It'll be usefull to compare the summary of premise before and after we make changes
premise <- victims$Premise
category <- as.character(premise)
summary(premise)

#I'll begin by combing food levels into simply restaurant
premise[which(premise == "FAST FOOD")] <- "RESTAURANT"
premise[which(premise == "CARRY OUT")] <- "RESTAURANT"
premise[which(premise == "CHAIN FOOD")] <- "RESTAURANT"
premise[which(premise == "PIZZA/OTHE")] <- "RESTAURANT"
premise[which(premise == "BAKERY")] <- "RESTAURANT"

#Done with food. All these are a BUSINESS category
category[which(category == "RESTAURANT")] <- "BUSINESS"

#I'll move on to residential
premise[which(premise == "APT/CONDO")] <- "APARTMENT"
premise[which(premise == "APT. LOCKE")] <- "APARTMENT"

#Done with houses and apartments. All of these are RESIDENTIAL category
category[which(category == "APARTMENT")] <- "RESIDENTIAL"

```

Neighborhoods are a much more consistent vector.

```{r neighborhoods}
#Replace blanks with NAs
neighborhoods <- victims$Neighborhood
neighborhoods[which(neighborhoods == "")] <- NA
neighborhoods <- factor(neighborhoods)
victims$Neighborhood <- neighborhoods
#Clean up
rm(neighborhoods)
```

Location has many, many levels. Note that the column Location.1 is the lat lon pair

```{r locations}
location <- victims$Location
#Convert blanks to NA
location[which(location == "")] <- NA
#Reset levels
location <- factor(location)
#Reassign
victims$Location <- location
#Clean up
rm(location)
```

Location.1 is the lat/lon pair. I'll clean this and rename it latLon.

```{r latlon}
latLon <- victims$Location.1
#Change blanks to NAs
latLon[latLon == ""] <- NA
victims$LatLon <- factor(latLon)
victims$Location.1 <- NULL
#Clean up
rm(latLon)
```

Weapon

```{r}
#Grab em
weapon <- victims$Weapon
#Replace blank with NA
weapon[which(weapon == "")] <- NA
#Reassign levels
weapon <- factor(weapon)
#Pop back into data frame
victims$Weapon <- weapon
```

Now it's time for a more complicated task: date.
There are two factor variables representing date and time. I'll combine them into one Date object
```{r}
#Append Time to Date
victims$CrimeDateTime <- paste(victims$CrimeDate, victims$CrimeTime)
#Let's look at it
str(victims$CrimeDateTime)
#Now let's convert these to date objects
victims$CrimeDateTime <- as.POSIXct(victims$CrimeDateTime, format = "%m/%d/%Y %H:%M:%S")
#Let's look at the new version
str(victims$CrimeDateTime)
#Let's wipe the uneeded Date and Time factors
victims$CrimeDate <- NULL
victims$CrimeTime <- NULL
```


 I'll grab the cherryHill neighborhood from the data set
```{r cherryHill}
cherryHill <- victims[which(victims$Neighborhood == "Cherry Hill"),]
```

I'm going to utilize ggmap to visualize these crimes.
```{r mapping cherry hill}
#Grab a map centered on the cherry hill neighborhood
cherryHillMap <- get_map("cherry hill, baltimore, maryland", zoom = 15)
#Plot all crimes
mapPoints <- ggmap(cherryHillMap) + geom_point(aes(x = Longitude, y = Latitude), data = cherryHill, alpha = .25)
#Titles
mapPoints <- mapPoints + ggtitle("Crime in Cherry Hill") + ylab("Latitude") + xlab("Longitude")

#Display it
mapPoints

mapPoints2 <- ggmap(cherryHillMap) + geom_point(aes(x = Longitude, y = Latitude, colour = Weapon), data = cherryHill, alpha = .75) + scale_colour_manual(values=cbbPalette)
mapPoints2 <- mapPoints2 + ggtitle("Crime in Cherry Hill by Weapon Used") + ylab("Latitude") + xlab("Longitude")

mapPoints2
```

Basic rpart decision tree on the cherryhill neighborhood.

```{r training tree on cherry hill}
#Form a 90-10 train test split
split <- sample(nrow(cherryHill), nrow(cherryHill) * 0.9)
#Divide the set into train and test
cherryHillTrain <- cherryHill[split,]
cherryHillTest <- cherryHill[-split,]
#Build the model
cherryHillModel <- rpart(cherryHillTrain, formula = CrimeCode ~ Description)
#Plot it
prp(cherryHillModel)
#Make two more models
cherryHillModel2 <- rpart(cherryHillTrain, formula = Weapon ~ Description)
```

TODO - Bin information by various time segments